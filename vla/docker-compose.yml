# SPDX-License-Identifier: MIT
# SPDX-FileCopyrightText: 2025 nop
#
# Docker Compose configuration for CRANE-X7 VLA training

services:
  # OpenVLA fine-tuning service
  vla-finetune-openvla:
    profiles:
      - openvla
      - finetune
    env_file: .env
    build:
      context: .
      dockerfile: Dockerfile.openvla
      target: base
      args:
        CUDA_VERSION: ${CUDA_VERSION:-12.1.0}
        PYTHON_VERSION: ${PYTHON_VERSION:-3.10}
        USER_ID: ${USER_ID:-1000}
        GROUP_ID: ${GROUP_ID:-1000}
        USERNAME: ${USERNAME:-vla}
    image: crane_x7_vla:openvla
    container_name: crane_x7_vla_finetune_openvla
    volumes:
      - type: bind
        source: "../data"
        target: "/workspace/data"
      - type: bind
        source: "../outputs"
        target: "/workspace/outputs"
      - type: bind
        source: "./src"
        target: "/workspace/vla/src"
      - type: bind
        source: "${HF_CACHE_DIR:-../.cache/huggingface}"
        target: "/home/${USERNAME:-vla}/.cache/huggingface"
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      - WANDB_API_KEY=${WANDB_API_KEY:-}
      - WANDB_MODE=${WANDB_MODE:-disabled}
      - HF_TOKEN=${HF_TOKEN:-}
      - HF_HOME=/home/${USERNAME:-vla}/.cache/huggingface
      - CUDA_VISIBLE_DEVICES=${CUDA_VISIBLE_DEVICES:-0}
      - TF_CPP_MIN_LOG_LEVEL=${TF_CPP_MIN_LOG_LEVEL:-2}
    working_dir: /workspace/vla
    stdin_open: true
    tty: true
    shm_size: ${SHM_SIZE:-16gb}
    ipc: host
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: ${GPU_COUNT:-all}
              capabilities: [gpu]
    command: python3 -m crane_x7_vla.training.cli train --backend openvla --data-root /workspace/data/tfrecord_logs

  # OpenPI fine-tuning service
  vla-finetune-openpi:
    profiles:
      - openpi
      - finetune
    env_file: .env
    build:
      context: .
      dockerfile: Dockerfile.openpi
      target: base
      args:
        CUDA_VERSION: ${CUDA_VERSION:-12.1.0}
        PYTHON_VERSION: ${PYTHON_VERSION:-3.10}
        USER_ID: ${USER_ID:-1000}
        GROUP_ID: ${GROUP_ID:-1000}
        USERNAME: ${USERNAME:-vla}
    image: crane_x7_vla:openpi
    container_name: crane_x7_vla_finetune_openpi
    volumes:
      - type: bind
        source: "../data"
        target: "/workspace/data"
      - type: bind
        source: "../outputs"
        target: "/workspace/outputs"
      - type: bind
        source: "./src"
        target: "/workspace/vla/src"
      - type: bind
        source: "${HF_CACHE_DIR:-../.cache/huggingface}"
        target: "/home/${USERNAME:-vla}/.cache/huggingface"
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      - WANDB_API_KEY=${WANDB_API_KEY:-}
      - WANDB_MODE=${WANDB_MODE:-disabled}
      - HF_TOKEN=${HF_TOKEN:-}
      - HF_HOME=/home/${USERNAME:-vla}/.cache/huggingface
      - CUDA_VISIBLE_DEVICES=${CUDA_VISIBLE_DEVICES:-0}
      - TF_CPP_MIN_LOG_LEVEL=${TF_CPP_MIN_LOG_LEVEL:-2}
    working_dir: /workspace/vla
    stdin_open: true
    tty: true
    shm_size: ${SHM_SIZE:-16gb}
    ipc: host
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: ${GPU_COUNT:-all}
              capabilities: [gpu]
    command: python3 -m crane_x7_vla.training.cli train --backend openpi --data-root /workspace/data/tfrecord_logs

networks:
  default:
    name: crane_x7
