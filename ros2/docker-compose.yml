# ============================================================================
# Common Configuration Anchors
# ============================================================================

# Build configuration
x-build-base: &build-base
  context: ..
  dockerfile: ros2/Dockerfile

# Volume configurations
x-x11-volumes: &x11-volumes
  - /tmp/.X11-unix:/tmp/.X11-unix:rw
  - /mnt/wslg:/mnt/wslg:ro
  - ./src:/workspace/ros2/src:ro

x-vla-volumes: &vla-volumes
  - /tmp/.X11-unix:/tmp/.X11-unix:rw
  - /mnt/wslg:/mnt/wslg:ro
  - ../vla/outputs:/workspace/vla/outputs:ro
  - ../data:/workspace/data:ro
  - ./src:/workspace/ros2/src:ro

# Environment configurations
x-base-env: &base-env
  DISPLAY: ${DISPLAY}
  PULSE_SERVER: unix:/run/user/1000/pulse/native
  TF_CPP_MIN_LOG_LEVEL: "2"
  CUDA_VISIBLE_DEVICES: ""

x-vla-env: &vla-env
  DISPLAY: ${DISPLAY}
  PULSE_SERVER: unix:/run/user/1000/pulse/native
  TF_CPP_MIN_LOG_LEVEL: "2"
  HF_TOKEN: ${HF_TOKEN:-}
  VLA_TASK_INSTRUCTION: ${VLA_TASK_INSTRUCTION:-pick up the object}
  VLA_DEVICE: ${VLA_DEVICE:-cuda}

# Group configurations
x-real-groups: &real-groups
  - dialout
  - audio
  - "984"  # video group GID on Arch Linux
  - "985"  # uucp group GID on Arch Linux

# Base service configuration
x-base: &base
  env_file: .env
  build:
    <<: *build-base
    target: base
  devices:
    - "/dev/snd:/dev/snd"
  volumes: *x11-volumes
  group_add:
    - audio
  environment:
    <<: *base-env

# GPU deployment configuration
x-gpu-deploy: &gpu-deploy
  resources:
    reservations:
      devices:
        - driver: nvidia
          count: 1
          capabilities: [gpu]

# ============================================================================
# Services
# ============================================================================

services:
  # --------------------------------------------------------------------------
  # Real Robot Services
  # --------------------------------------------------------------------------
  real:
    <<: *base
    profiles: [real]
    devices:
      - "$USB_DEVICE:/dev/ttyUSB0"
      - "/dev/snd:/dev/snd"
    privileged: true
    group_add: *real-groups
    command: ros2 launch crane_x7_log real.launch.py use_d435:=${USE_D435:-false} use_viewer:=${USE_VIEWER:-false}

  # --------------------------------------------------------------------------
  # Simulation Services
  # --------------------------------------------------------------------------
  sim:
    <<: *base
    profiles: [sim]
    environment:
      <<: *base-env
      SIMULATION_MODE: "true"
    command: ros2 launch crane_x7_log sim.launch.py use_viewer:=${USE_VIEWER:-false}

  # --------------------------------------------------------------------------
  # Teleoperation Services
  # --------------------------------------------------------------------------
  teleop-leader:
    <<: *base
    profiles: [teleop, teleop-viewer]
    devices:
      - "$USB_DEVICE:/dev/ttyUSB0"
      - "/dev/snd:/dev/snd"
    privileged: true
    group_add: *real-groups
    stop_grace_period: 5s
    stop_signal: SIGINT
    command: ros2 launch crane_x7_log teleop_leader.launch.py use_d435:=${USE_D435:-false} use_viewer:=false

  teleop-follower:
    <<: *base
    profiles: [teleop]
    devices:
      - "${USB_DEVICE_FOLLOWER:-/dev/ttyUSB1}:/dev/ttyUSB0"
      - "/dev/snd:/dev/snd"
    group_add: *real-groups
    stop_grace_period: 5s
    stop_signal: SIGINT
    command: ros2 launch crane_x7_teleop teleop_follower.launch.py

  teleop-follower-viewer:
    <<: *base
    profiles: [teleop-viewer]
    devices:
      - "${USB_DEVICE_FOLLOWER:-/dev/ttyUSB1}:/dev/ttyUSB0"
      - "/dev/snd:/dev/snd"
    privileged: true
    group_add: *real-groups
    stop_grace_period: 5s
    stop_signal: SIGINT
    command: ros2 launch crane_x7_teleop teleop_follower.launch.py use_d435:=true use_viewer:=true

  # --------------------------------------------------------------------------
  # Gemini Services
  # --------------------------------------------------------------------------
  gemini:
    <<: *base
    profiles: [gemini]
    devices:
      - "$USB_DEVICE:/dev/ttyUSB0"
      - "/dev/snd:/dev/snd"
    privileged: true
    group_add: *real-groups
    environment:
      <<: *base-env
      GEMINI_API_KEY: ${GEMINI_API_KEY}
    command: ros2 launch crane_x7_gemini gemini_with_robot.launch.py

  gemini-sim:
    <<: *base
    profiles: [gemini-sim]
    environment:
      <<: *base-env
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      SIMULATION_MODE: "true"
    command: ros2 launch crane_x7_gemini gemini_pick_and_place_sim.launch.py

  # --------------------------------------------------------------------------
  # VLA Inference Services
  # --------------------------------------------------------------------------
  vla:
    <<: *base
    profiles: [vla]
    devices:
      - "$USB_DEVICE:/dev/ttyUSB0"
      - "/dev/snd:/dev/snd"
    volumes: *vla-volumes
    privileged: true
    group_add: *real-groups
    environment:
      <<: *vla-env
    deploy:
      <<: *gpu-deploy
    command: >
      ros2 launch crane_x7_vla real_with_vla.launch.py
        task_instruction:='${VLA_TASK_INSTRUCTION}'
        device:='${VLA_DEVICE:-cuda}'
        use_d435:=true

  vla-sim:
    <<: *base
    profiles: [vla-sim]
    volumes: *vla-volumes
    environment:
      <<: *vla-env
      SIMULATION_MODE: "true"
    deploy:
      <<: *gpu-deploy
    command: >
      ros2 launch crane_x7_vla sim_with_vla.launch.py
        task_instruction:='${VLA_TASK_INSTRUCTION}'
        device:='${VLA_DEVICE:-cuda}'

# ============================================================================
# Networks
# ============================================================================

networks:
  default:
    name: crane_x7
