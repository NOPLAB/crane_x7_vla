# ============================================================================
# Common Configuration Anchors
# ============================================================================

# Build configuration
x-build-base: &build-base
  context: ../..
  dockerfile: ros2/docker/Dockerfile

# Volume configurations
x-x11-volumes: &x11-volumes
  - /tmp/.X11-unix:/tmp/.X11-unix:rw
  - /mnt/wslg:/mnt/wslg:ro
  - ../src:/workspace/ros2/src:ro
  - ../../data:/workspace/data:rw
  - /run/user/1000/pulse:/run/user/1000/pulse:ro

x-vla-volumes: &vla-volumes
  - /tmp/.X11-unix:/tmp/.X11-unix:rw
  - /mnt/wslg:/mnt/wslg:ro
  - ../../vla/outputs:/workspace/vla/outputs:ro
  - ../../data:/workspace/data:ro
  - ../src:/workspace/ros2/src:ro
  - ${HF_CACHE_DIR:-${HOME}/.cache/huggingface}:/home/${USERNAME:-ros2}/.cache/huggingface:rw

x-lift-volumes: &lift-volumes
  - /tmp/.X11-unix:/tmp/.X11-unix:rw
  - /mnt/wslg:/mnt/wslg:ro
  - ../../sim/src:/workspace/sim/src:ro
  - ../../vla/outputs:/workspace/vla/outputs:ro
  - ../../data:/workspace/data:rw
  - ../src:/workspace/ros2/src:ro
  - ${HF_CACHE_DIR:-${HOME}/.cache/huggingface}:/home/${USERNAME:-ros2}/.cache/huggingface:rw

# Environment configurations
x-base-env: &base-env
  DISPLAY: ${DISPLAY}
  PULSE_SERVER: unix:/run/user/1000/pulse/native
  TF_CPP_MIN_LOG_LEVEL: "2"
  CUDA_VISIBLE_DEVICES: ""

x-vla-env: &vla-env
  DISPLAY: ${DISPLAY}
  PULSE_SERVER: unix:/run/user/1000/pulse/native
  TF_CPP_MIN_LOG_LEVEL: "2"
  HF_TOKEN: ${HF_TOKEN:-}
  HF_HOME: /home/${USERNAME:-ros2}/.cache/huggingface
  VLA_TASK_INSTRUCTION: ${VLA_TASK_INSTRUCTION:-pick up the object}
  VLA_DEVICE: ${VLA_DEVICE:-cuda}

x-lift-env: &lift-env
  DISPLAY: ${DISPLAY}
  PULSE_SERVER: unix:/run/user/1000/pulse/native
  TF_CPP_MIN_LOG_LEVEL: "2"
  LIFT_SIMULATOR: ${LIFT_SIMULATOR:-maniskill}
  LIFT_BACKEND: ${LIFT_BACKEND:-cpu}
  LIFT_RENDER_MODE: ${LIFT_RENDER_MODE:-none}

# Group configurations
x-real-groups: &real-groups
  - dialout
  - audio
  - "984"  # video group GID on Arch Linux
  - "985"  # uucp group GID on Arch Linux

# Base service configuration
x-base: &base
  env_file: .env
  build:
    <<: *build-base
    target: base
  devices:
    - "/dev/snd:/dev/snd"
  volumes: *x11-volumes
  group_add:
    - audio
  environment:
    <<: *base-env

# GPU deployment configuration
x-gpu-deploy: &gpu-deploy
  resources:
    reservations:
      devices:
        - driver: nvidia
          count: 1
          capabilities: [gpu]

# ============================================================================
# Services
# ============================================================================

services:
  # --------------------------------------------------------------------------
  # Real Robot Services
  # --------------------------------------------------------------------------
  real:
    <<: *base
    profiles: [real]
    devices:
      - "$USB_DEVICE:/dev/ttyUSB0"
      - "/dev/snd:/dev/snd"
    privileged: true
    group_add: *real-groups
    command: ros2 launch crane_x7_bringup real.launch.py use_d435:=${USE_D435:-false} use_viewer:=${USE_VIEWER:-false}

  # --------------------------------------------------------------------------
  # Simulation Services
  # --------------------------------------------------------------------------
  sim:
    <<: *base
    profiles: [sim]
    environment:
      <<: *base-env
      SIMULATION_MODE: "true"
    command: ros2 launch crane_x7_bringup sim.launch.py use_viewer:=${USE_VIEWER:-false}

  # --------------------------------------------------------------------------
  # Teleoperation Services
  # --------------------------------------------------------------------------
  # Usage:
  #   docker compose --profile teleop up           # Leader + Follower only
  #   docker compose --profile teleop --profile log up  # + Camera + Logger
  #
  teleop-leader:
    <<: *base
    profiles: [teleop, log]
    devices:
      - "$USB_DEVICE:/dev/ttyUSB0"
      - "/dev/snd:/dev/snd"
    privileged: true
    group_add: *real-groups
    stop_grace_period: 5s
    stop_signal: SIGINT
    command: ros2 launch crane_x7_teleop teleop_leader.launch.py

  teleop-follower:
    <<: *base
    profiles: [teleop, log]
    devices:
      - "${USB_DEVICE_FOLLOWER:-/dev/ttyUSB1}:/dev/ttyUSB0"
      - "/dev/snd:/dev/snd"
    group_add: *real-groups
    stop_grace_period: 5s
    stop_signal: SIGINT
    command: ros2 launch crane_x7_teleop teleop_follower.launch.py

  teleop-logger:
    <<: *base
    profiles: [log]
    privileged: true
    group_add: *real-groups
    stop_grace_period: 5s
    stop_signal: SIGINT
    command:
      - /bin/bash
      - -c
      - |
        CAMERA_ARGS="camera_serial:='${CAMERA_SERIAL:-}'"
        if [ -n "${CAMERA2_SERIAL:-}" ]; then
          CAMERA_ARGS="$$CAMERA_ARGS camera2_serial:='${CAMERA2_SERIAL}'"
        fi
        ros2 launch crane_x7_bringup data_collection.launch.py \
          use_viewer:=${USE_VIEWER:-true} \
          $$CAMERA_ARGS

  # --------------------------------------------------------------------------
  # Gemini Services
  # --------------------------------------------------------------------------
  gemini-real:
    <<: *base
    profiles: [gemini]
    devices:
      - "$USB_DEVICE:/dev/ttyUSB0"
      - "/dev/snd:/dev/snd"
    privileged: true
    group_add: *real-groups
    environment:
      <<: *base-env
      GEMINI_API_KEY: ${GEMINI_API_KEY}
    command: ros2 launch crane_x7_bringup gemini_real.launch.py

  gemini-sim:
    <<: *base
    profiles: [gemini-sim]
    environment:
      <<: *base-env
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      SIMULATION_MODE: "true"
    command: ros2 launch crane_x7_bringup gemini_sim.launch.py

  # --------------------------------------------------------------------------
  # VLA Inference Services
  # --------------------------------------------------------------------------
  vla-real:
    <<: *base
    profiles: [vla]
    devices:
      - "$USB_DEVICE:/dev/ttyUSB0"
      - "/dev/snd:/dev/snd"
    volumes: *vla-volumes
    privileged: true
    group_add: *real-groups
    environment:
      <<: *vla-env
    deploy:
      <<: *gpu-deploy
    command: >
      ros2 launch crane_x7_bringup vla_real.launch.py
        model_path:='${VLA_MODEL_PATH}'
        task_instruction:='${VLA_TASK_INSTRUCTION}'
        device:='${VLA_DEVICE:-cuda}'
        use_d435:=true

  vla-sim:
    <<: *base
    profiles: [vla-sim]
    volumes: *vla-volumes
    environment:
      <<: *vla-env
      SIMULATION_MODE: "true"
    deploy:
      <<: *gpu-deploy
    command: >
      ros2 launch crane_x7_bringup vla_sim.launch.py
        model_path:='${VLA_MODEL_PATH}'
        task_instruction:='${VLA_TASK_INSTRUCTION}'
        device:='${VLA_DEVICE:-cuda}'

  # --------------------------------------------------------------------------
  # Lift Simulation Services (unified simulator abstraction)
  # --------------------------------------------------------------------------
  lift:
    <<: *base
    profiles: [lift]
    volumes: *lift-volumes
    environment:
      <<: *lift-env
    command: >
      ros2 launch crane_x7_bringup lift.launch.py
        simulator:='${LIFT_SIMULATOR:-maniskill}'
        backend:='${LIFT_BACKEND:-cpu}'
        render_mode:='${LIFT_RENDER_MODE:-none}'

  lift-vla:
    <<: *base
    profiles: [lift-vla]
    volumes: *lift-volumes
    environment:
      <<: *vla-env
      LIFT_SIMULATOR: ${LIFT_SIMULATOR:-maniskill}
    deploy:
      <<: *gpu-deploy
    command: >
      ros2 launch crane_x7_bringup lift_vla.launch.py
        simulator:='${LIFT_SIMULATOR:-maniskill}'
        model_path:='${VLA_MODEL_PATH}'
        task_instruction:='${VLA_TASK_INSTRUCTION}'
        device:='${VLA_DEVICE:-cuda}'

  lift-logger:
    <<: *base
    profiles: [lift-logger]
    volumes: *lift-volumes
    environment:
      <<: *lift-env
    deploy:
      <<: *gpu-deploy
    command: >
      ros2 launch crane_x7_bringup lift_logger.launch.py
        simulator:='${LIFT_SIMULATOR:-maniskill}'
        backend:='${LIFT_BACKEND:-gpu}'

# ============================================================================
# Networks
# ============================================================================

networks:
  default:
    name: crane_x7
