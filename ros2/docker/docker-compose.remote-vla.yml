# ============================================================================
# CRANE-X7 Remote VLA Configuration
# ============================================================================
# SPDX-License-Identifier: MIT
# SPDX-FileCopyrightText: 2025 nop
#
# This docker-compose file is for the LOCAL ROBOT side when using remote
# VLA inference on external GPU servers (Runpod/Vast.ai).
#
# Architecture:
#   [Remote GPU Server]                [Local Robot (this compose)]
#   ┌─────────────────┐               ┌─────────────────────────┐
#   │ vla_inference   │◄──Tailscale──►│ Tailscale sidecar      │
#   │ _node           │      VPN      │                        │
#   │                 │               │ demo.launch.py         │
#   │ /vla/predicted  │───────────────│ robot_controller       │
#   │ _action         │               │ RealSense D435         │
#   └─────────────────┘               └─────────────────────────┘
#
# Usage:
#   1. Copy .env.template to .env and configure:
#      - TS_AUTHKEY: Tailscale auth key
#      - REMOTE_INFERENCE_IP: Tailscale IP of the remote inference server
#      - USB_DEVICE: Robot USB port
#
#   2. Start the services:
#      docker compose -f docker-compose.remote-vla.yml --profile real-remote up
#
#   3. On the remote GPU server, run the inference container with:
#      - LOCAL_PEER_IP set to this machine's Tailscale IP
#
# ============================================================================

# ============================================================================
# Common Configuration Anchors
# ============================================================================

x-build-base: &build-base
  context: ../..
  dockerfile: ros2/docker/Dockerfile

x-base-env: &base-env
  DISPLAY: ${DISPLAY}
  PULSE_SERVER: unix:/run/user/1000/pulse/native
  TF_CPP_MIN_LOG_LEVEL: "2"
  CUDA_VISIBLE_DEVICES: ""
  # CycloneDDS unicast configuration for VPN communication
  RMW_IMPLEMENTATION: rmw_cyclonedds_cpp
  CYCLONEDDS_URI: /etc/cyclonedds.xml
  ROS_DOMAIN_ID: ${ROS_DOMAIN_ID:-42}

x-real-groups: &real-groups
  - dialout
  - audio
  - "984"  # video group GID on Arch Linux
  - "985"  # uucp group GID on Arch Linux

# ============================================================================
# Services
# ============================================================================

services:
  # --------------------------------------------------------------------------
  # Tailscale Sidecar (Local VPN Connection)
  # --------------------------------------------------------------------------
  # This container provides VPN connectivity for the robot services.
  # Other services use network_mode: service:tailscale-local to share
  # the Tailscale network interface.
  tailscale-local:
    image: tailscale/tailscale:latest
    profiles: [real-remote, real-remote-viewer]
    hostname: crane-x7-local
    environment:
      - TS_AUTHKEY=${TS_AUTHKEY}
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_USERSPACE=${TS_USERSPACE:-false}
      - TS_EXTRA_ARGS=--accept-routes --hostname=crane-x7-local
    volumes:
      - tailscale-state:/var/lib/tailscale
      - /dev/net/tun:/dev/net/tun
    cap_add:
      - NET_ADMIN
      - NET_RAW
    restart: unless-stopped

  # --------------------------------------------------------------------------
  # Real Robot with Remote VLA (No VLA Inference Node)
  # --------------------------------------------------------------------------
  # Runs robot hardware control and robot_controller.
  # VLA inference runs on a remote GPU server and communicates via Tailscale.
  real-remote:
    env_file: .env
    build:
      <<: *build-base
      target: base
    profiles: [real-remote]
    depends_on:
      - tailscale-local
    network_mode: service:tailscale-local
    devices:
      - "$USB_DEVICE:/dev/ttyUSB0"
      - "/dev/snd:/dev/snd"
    privileged: true
    group_add: *real-groups
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - /mnt/wslg:/mnt/wslg:ro
      - ../src:/workspace/ros2/src:ro
      - ./cyclonedds-local.xml:/etc/cyclonedds-template.xml:ro
    environment:
      <<: *base-env
      REMOTE_INFERENCE_IP: ${REMOTE_INFERENCE_IP:-}
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        # Generate CycloneDDS config with peer IP
        if [ -n "$$REMOTE_INFERENCE_IP" ]; then
          echo "Configuring CycloneDDS with peer: $$REMOTE_INFERENCE_IP"
          envsubst < /etc/cyclonedds-template.xml > /etc/cyclonedds.xml
        else
          echo "WARNING: REMOTE_INFERENCE_IP not set"
          cp /etc/cyclonedds-template.xml /etc/cyclonedds.xml
        fi
        # Source ROS 2 and run launch
        source /opt/ros/humble/setup.bash
        source /workspace/ros2/install/setup.bash
        ros2 launch crane_x7_vla remote_robot.launch.py \
          port_name:='/dev/ttyUSB0' \
          use_d435:=true \
          use_viewer:=false \
          auto_execute:=true

  # --------------------------------------------------------------------------
  # Real Robot with Remote VLA + Camera Viewer
  # --------------------------------------------------------------------------
  real-remote-viewer:
    env_file: .env
    build:
      <<: *build-base
      target: base
    profiles: [real-remote-viewer]
    depends_on:
      - tailscale-local
    network_mode: service:tailscale-local
    devices:
      - "$USB_DEVICE:/dev/ttyUSB0"
      - "/dev/snd:/dev/snd"
    privileged: true
    group_add: *real-groups
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - /mnt/wslg:/mnt/wslg:ro
      - ../src:/workspace/ros2/src:ro
      - ./cyclonedds-local.xml:/etc/cyclonedds-template.xml:ro
    environment:
      <<: *base-env
      REMOTE_INFERENCE_IP: ${REMOTE_INFERENCE_IP:-}
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        # Generate CycloneDDS config with peer IP
        if [ -n "$$REMOTE_INFERENCE_IP" ]; then
          echo "Configuring CycloneDDS with peer: $$REMOTE_INFERENCE_IP"
          envsubst < /etc/cyclonedds-template.xml > /etc/cyclonedds.xml
        else
          echo "WARNING: REMOTE_INFERENCE_IP not set"
          cp /etc/cyclonedds-template.xml /etc/cyclonedds.xml
        fi
        # Source ROS 2 and run launch
        source /opt/ros/humble/setup.bash
        source /workspace/ros2/install/setup.bash
        ros2 launch crane_x7_vla remote_robot.launch.py \
          port_name:='/dev/ttyUSB0' \
          use_d435:=true \
          use_viewer:=true \
          auto_execute:=true

# ============================================================================
# Volumes
# ============================================================================
volumes:
  tailscale-state:
    name: crane_x7_tailscale_state

# ============================================================================
# Networks
# ============================================================================
networks:
  default:
    name: crane_x7_remote
