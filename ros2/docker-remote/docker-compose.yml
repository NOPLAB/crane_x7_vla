# ============================================================================
# CRANE-X7 Remote VLA Configuration (rosbridge WebSocket)
# ============================================================================
# SPDX-License-Identifier: MIT
# SPDX-FileCopyrightText: 2025 nop
#
# This docker-compose file is for the LOCAL ROBOT side when using remote
# VLA inference on external GPU servers (Runpod/Vast.ai).
#
# Uses rosbridge_server (WebSocket) instead of CycloneDDS UDP for reliable
# communication over Tailscale VPN (including userspace networking mode).
#
# Architecture:
#   [Remote GPU Server]                [Local Robot (this compose)]
#   ┌─────────────────┐               ┌─────────────────────────┐
#   │ vla_inference   │               │ Tailscale sidecar       │
#   │ _rosbridge.py   │◄──Tailscale──►│                         │
#   │ (roslibpy)      │   WebSocket   │ rosbridge_server :9090  │
#   │                 │               │                         │
#   │ /vla/predicted  │───────────────│ robot_controller        │
#   │ _action         │               │ RealSense D435          │
#   └─────────────────┘               └─────────────────────────┘
#
# Usage:
#   1. Copy .env.template to .env and configure:
#      - TS_AUTHKEY: Tailscale auth key
#      - USB_DEVICE: Robot USB port (for real robot)
#
#   2. Start the services:
#      cd ros2/docker-remote
#      docker compose --profile sim up          # Simulation
#      docker compose --profile sim-viewer up   # Simulation + RViz
#      docker compose --profile real up         # Real robot
#
#   3. On the remote GPU server, run:
#      docker run --gpus all \
#        -e TS_AUTHKEY=tskey-auth-xxx \
#        -e ROSBRIDGE_HOST=crane-x7-local \
#        -e VLA_MODEL_PATH=sikip/openvla-7b-finetuned-crane-x7 \
#        crane_x7_vla-rosbridge
#
# ============================================================================

# ============================================================================
# Common Configuration Anchors
# ============================================================================

x-build-base: &build-base
  context: ../..
  dockerfile: ros2/docker/Dockerfile

x-base-env: &base-env
  DISPLAY: ${DISPLAY}
  PULSE_SERVER: unix:/run/user/1000/pulse/native
  TF_CPP_MIN_LOG_LEVEL: "2"
  CUDA_VISIBLE_DEVICES: ""
  ROS_DOMAIN_ID: ${ROS_DOMAIN_ID:-42}

x-real-groups: &real-groups
  - dialout
  - audio
  - "984"  # video group GID on Arch Linux
  - "985"  # uucp group GID on Arch Linux

# ============================================================================
# Services
# ============================================================================

services:
  # --------------------------------------------------------------------------
  # Tailscale Sidecar (Local VPN Connection)
  # --------------------------------------------------------------------------
  # This container provides VPN connectivity for the robot services.
  # Other services use network_mode: service:tailscale-local to share
  # the Tailscale network interface and DNS resolution.
  tailscale-local:
    image: tailscale/tailscale:latest
    profiles: [real, real-viewer, sim, sim-viewer]
    hostname: crane-x7-local
    environment:
      - TS_AUTHKEY=${TS_AUTHKEY}
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_USERSPACE=${TS_USERSPACE:-false}
      - TS_EXTRA_ARGS=--accept-routes
      - TS_HOSTNAME=crane-x7-local
    volumes:
      - tailscale-state:/var/lib/tailscale
      - /dev/net/tun:/dev/net/tun
    cap_add:
      - NET_ADMIN
      - NET_RAW
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "tailscale status | grep -q 'offers exit node'|| tailscale status | grep -q '^100\\.'"]
      interval: 5s
      timeout: 5s
      retries: 12
      start_period: 15s

  # --------------------------------------------------------------------------
  # Real Robot with rosbridge
  # --------------------------------------------------------------------------
  # Runs robot hardware control, rosbridge_server, and robot_controller.
  # VLA inference runs on a remote GPU server via rosbridge WebSocket.
  real:
    env_file: .env
    build:
      <<: *build-base
      target: base
    profiles: [real]
    depends_on:
      tailscale-local:
        condition: service_healthy
    network_mode: service:tailscale-local
    devices:
      - "$USB_DEVICE:/dev/ttyUSB0"
      - "/dev/snd:/dev/snd"
    privileged: true
    group_add: *real-groups
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - /mnt/wslg:/mnt/wslg:ro
      - ../src:/workspace/ros2/src:ro
    environment:
      <<: *base-env
      ROSBRIDGE_PORT: ${ROSBRIDGE_PORT:-9090}
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        source /opt/ros/humble/setup.bash
        source /workspace/ros2/install/setup.bash
        ros2 launch crane_x7_bringup rosbridge_real.launch.py \
          port_name:='/dev/ttyUSB0' \
          use_d435:=true \
          use_viewer:=false \
          auto_execute:=true \
          rosbridge_port:=$${ROSBRIDGE_PORT:-9090}

  # --------------------------------------------------------------------------
  # Real Robot with rosbridge + Camera Viewer
  # --------------------------------------------------------------------------
  real-viewer:
    env_file: .env
    build:
      <<: *build-base
      target: base
    profiles: [real-viewer]
    depends_on:
      tailscale-local:
        condition: service_healthy
    network_mode: service:tailscale-local
    devices:
      - "$USB_DEVICE:/dev/ttyUSB0"
      - "/dev/snd:/dev/snd"
    privileged: true
    group_add: *real-groups
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - /mnt/wslg:/mnt/wslg:ro
      - ../src:/workspace/ros2/src:ro
    environment:
      <<: *base-env
      ROSBRIDGE_PORT: ${ROSBRIDGE_PORT:-9090}
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        source /opt/ros/humble/setup.bash
        source /workspace/ros2/install/setup.bash
        ros2 launch crane_x7_bringup rosbridge_real.launch.py \
          port_name:='/dev/ttyUSB0' \
          use_d435:=true \
          use_viewer:=true \
          auto_execute:=true \
          rosbridge_port:=$${ROSBRIDGE_PORT:-9090}

  # --------------------------------------------------------------------------
  # Simulation with rosbridge
  # --------------------------------------------------------------------------
  # Runs Gazebo simulation, rosbridge_server, and robot_controller.
  # VLA inference runs on a remote GPU server via rosbridge WebSocket.
  sim:
    env_file: .env
    build:
      <<: *build-base
      target: base
    profiles: [sim]
    depends_on:
      tailscale-local:
        condition: service_healthy
    network_mode: service:tailscale-local
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - /mnt/wslg:/mnt/wslg:ro
      - ../src:/workspace/ros2/src:ro
    environment:
      <<: *base-env
      SIMULATION_MODE: "true"
      ROSBRIDGE_PORT: ${ROSBRIDGE_PORT:-9090}
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        source /opt/ros/humble/setup.bash
        source /workspace/ros2/install/setup.bash
        ros2 launch crane_x7_bringup rosbridge_sim.launch.py \
          use_viewer:=false \
          auto_execute:=true \
          rosbridge_port:=$${ROSBRIDGE_PORT:-9090}

  # --------------------------------------------------------------------------
  # Simulation with rosbridge + Viewer
  # --------------------------------------------------------------------------
  sim-viewer:
    env_file: .env
    build:
      <<: *build-base
      target: base
    profiles: [sim-viewer]
    depends_on:
      tailscale-local:
        condition: service_healthy
    network_mode: service:tailscale-local
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - /mnt/wslg:/mnt/wslg:ro
      - ../src:/workspace/ros2/src:ro
    environment:
      <<: *base-env
      SIMULATION_MODE: "true"
      ROSBRIDGE_PORT: ${ROSBRIDGE_PORT:-9090}
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        source /opt/ros/humble/setup.bash
        source /workspace/ros2/install/setup.bash
        ros2 launch crane_x7_bringup rosbridge_sim.launch.py \
          use_viewer:=true \
          auto_execute:=true \
          rosbridge_port:=$${ROSBRIDGE_PORT:-9090}

# ============================================================================
# Volumes
# ============================================================================
volumes:
  tailscale-state:
    name: crane_x7_tailscale_state

# ============================================================================
# Networks
# ============================================================================
networks:
  default:
    name: crane_x7_remote
