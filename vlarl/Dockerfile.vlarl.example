# syntax=docker/dockerfile:1
# SPDX-License-Identifier: MIT
# SPDX-FileCopyrightText: 2025 nop
#
# VLA-RL Dockerfile for CRANE-X7
# Extends OpenVLA environment with RL training capabilities

ARG BASE_IMAGE=crane_x7_vla_openvla:latest

# ============================================================================
# VLA-RL Stage: Add RL training dependencies
# ============================================================================
FROM ${BASE_IMAGE} AS vlarl

# Install additional RL dependencies
COPY requirements.txt /build/requirements-vlarl.txt

RUN --mount=type=cache,target=/root/.cache/pip \
    pip3 install -r /build/requirements-vlarl.txt

# Copy lift simulator
COPY ../sim /workspace/sim
WORKDIR /workspace/sim
RUN --mount=type=cache,target=/root/.cache/pip \
    pip3 install -e ".[maniskill,genesis]"

# Copy vlarl package
COPY . /workspace/vlarl
WORKDIR /workspace/vlarl
RUN --mount=type=cache,target=/root/.cache/pip \
    pip3 install -e .

# Set environment
ENV PYTHONPATH=/workspace/vlarl/src:/workspace/sim/src:${PYTHONPATH}
ENV WANDB_DIR=/workspace/vlarl/outputs

# Create outputs directory
RUN mkdir -p /workspace/vlarl/outputs

WORKDIR /workspace

# Default command
CMD ["python", "-m", "crane_x7_vlarl.training.cli", "--help"]


# ============================================================================
# Development Stage: Additional dev tools
# ============================================================================
FROM vlarl AS dev

RUN --mount=type=cache,target=/root/.cache/pip \
    pip3 install \
        pytest \
        pytest-cov \
        ipython \
        jupyter \
        black \
        ruff

CMD ["/bin/bash"]
